#!/usr/bin/env python3
"""
Universal Vulnerability Scanner - Main CLI
Command-line interface for vulnerability scanning across multiple ecosystems
"""

import argparse
import json
import sys
from pathlib import Path
from datetime import datetime
from typing import List

from .models.vulnerability import VulnerabilityDatabase
from .models.finding import Finding, Verdict, Severity
from .scanners.npm_scanner import NPMScanner
from .integrations.phoenix_uploader import PhoenixConfig, PhoenixUploader


def generate_report(findings: List[Finding], output_file: str = None) -> str:
    """Generate human-readable report from findings."""
    lines = []
    lines.append("=" * 80)
    lines.append("UNIVERSAL VULNERABILITY SCANNER REPORT")
    lines.append("=" * 80)
    lines.append(f"Scan completed: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    lines.append("")
    
    # Statistics
    verdict_counts = {
        Verdict.VULNERABLE: 0,
        Verdict.SAFE: 0,
        Verdict.CLEAN: 0,
        Verdict.REVIEW: 0,
        Verdict.FIXED: 0
    }
    
    severity_counts = {
        Severity.CRITICAL: 0,
        Severity.HIGH: 0,
        Severity.MEDIUM: 0,
        Severity.LOW: 0,
        Severity.INFO: 0
    }
    
    for f in findings:
        verdict_counts[f.verdict] += 1
        severity_counts[f.severity] += 1
    
    lines.append("SUMMARY:")
    lines.append("-" * 40)
    lines.append(f"Total findings: {len(findings)}")
    lines.append(f"  VULNERABLE:  {verdict_counts[Verdict.VULNERABLE]}")
    lines.append(f"  SAFE:        {verdict_counts[Verdict.SAFE]}")
    lines.append(f"  CLEAN:       {verdict_counts[Verdict.CLEAN]}")
    lines.append(f"  REVIEW:      {verdict_counts[Verdict.REVIEW]}")
    lines.append("")
    
    lines.append("SEVERITY BREAKDOWN:")
    lines.append("-" * 40)
    lines.append(f"  CRITICAL: {severity_counts[Severity.CRITICAL]}")
    lines.append(f"  HIGH:     {severity_counts[Severity.HIGH]}")
    lines.append(f"  MEDIUM:   {severity_counts[Severity.MEDIUM]}")
    lines.append(f"  LOW:      {severity_counts[Severity.LOW]}")
    lines.append(f"  INFO:     {severity_counts[Severity.INFO]}")
    lines.append("")
    
    # Vulnerable findings
    vulnerable = [f for f in findings if f.verdict == Verdict.VULNERABLE]
    if vulnerable:
        lines.append("=" * 80)
        lines.append("üö® VULNERABLE PACKAGES DETECTED")
        lines.append("=" * 80)
        lines.append("")
        
        for i, finding in enumerate(vulnerable, 1):
            lines.append(f"{i}. {finding.package}@{finding.version}")
            lines.append(f"   File: {finding.path}")
            lines.append(f"   Reason: {finding.reason}")
            if finding.safe_version:
                lines.append(f"   ‚úÖ Safe version: {finding.safe_version}")
            if finding.cve_ids:
                lines.append(f"   CVE: {', '.join(finding.cve_ids)}")
            lines.append("")
    
    # Safe versions of vulnerable packages
    safe = [f for f in findings if f.verdict == Verdict.SAFE]
    if safe:
        lines.append("=" * 80)
        lines.append("‚úÖ SAFE VERSIONS (of monitored packages)")
        lines.append("=" * 80)
        lines.append("")
        
        for i, finding in enumerate(safe, 1):
            lines.append(f"{i}. {finding.package}@{finding.version}")
            lines.append(f"   File: {finding.path}")
            lines.append(f"   Note: {finding.reason}")
            lines.append("")
    
    # Review needed
    review = [f for f in findings if f.verdict == Verdict.REVIEW]
    if review:
        lines.append("=" * 80)
        lines.append("‚ö†Ô∏è  REQUIRES REVIEW")
        lines.append("=" * 80)
        lines.append("")
        
        for i, finding in enumerate(review[:10], 1):
            lines.append(f"{i}. {finding.package}@{finding.version}")
            lines.append(f"   File: {finding.path}")
            lines.append(f"   Reason: {finding.reason}")
            lines.append("")
        
        if len(review) > 10:
            lines.append(f"... and {len(review) - 10} more needing review")
            lines.append("")
    
    report = "\n".join(lines)
    
    # Save to file if requested
    if output_file:
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(report)
        print(f"üìÑ Report saved to: {output_file}")
    
    return report


def scan_command(args):
    """Execute scan command."""
    target = Path(args.target)
    
    if not target.exists():
        print(f"‚ùå Target not found: {target}")
        return 1
    
    # Load vulnerability database
    db_path = Path(args.database) if args.database else Path(__file__).parent / "data" / "vulnerability_database.json"
    
    if not db_path.exists():
        print(f"‚ùå Vulnerability database not found: {db_path}")
        print("üí° Tip: Specify database with --database option")
        return 1
    
    print(f"üìÇ Loading vulnerability database: {db_path}")
    vuln_db = VulnerabilityDatabase(db_path)
    print(f"‚úÖ Loaded {vuln_db.get_stats()['total_vulnerabilities']} vulnerabilities")
    print()
    
    # Initialize scanner
    print(f"üîç Scanning: {target}")
    scanner = NPMScanner(vuln_db)
    
    # Scan
    findings = scanner.scan_path(target)
    
    print(f"‚úÖ Scan complete: {len(findings)} findings")
    print()
    
    # Upload to Phoenix if requested
    if args.upload_phoenix:
        print("üöÄ Uploading to Phoenix Security...")
        config = PhoenixConfig(args.phoenix_config)
        
        if not config.is_configured():
            print("‚ùå Phoenix not configured. Use --create-phoenix-config to generate template.")
            print("   Or set environment variables: PHOENIX_CLIENT_ID, PHOENIX_CLIENT_SECRET, PHOENIX_API_URL")
        else:
            uploader = PhoenixUploader(config, debug_mode=args.debug)
            success = uploader.upload_findings(findings, repository=str(target))
            if success:
                print("‚úÖ Phoenix upload successful")
            else:
                print("‚ùå Phoenix upload failed")
        print()
    
    # Generate report
    if args.json:
        # JSON output
        json_data = [f.to_dict() for f in findings]
        with open(args.output or "scan_results.json", 'w', encoding='utf-8') as f:
            json.dump(json_data, f, indent=2, ensure_ascii=False)
        print(f"üìÑ JSON report saved to: {args.output or 'scan_results.json'}")
    else:
        # Text report
        report = generate_report(findings, args.output)
        if not args.quiet:
            print(report)
    
    # Exit code based on findings
    critical_count = sum(1 for f in findings if f.verdict == Verdict.VULNERABLE)
    return 1 if critical_count > 0 else 0


def test_command(args):
    """Run tests on sample data."""
    test_samples = Path(__file__).parent / "test_samples"
    
    if not test_samples.exists():
        print(f"‚ùå Test samples not found: {test_samples}")
        return 1
    
    print("üß™ Running tests on sample data...")
    print()
    
    # Use scan_command with test samples
    class TestArgs:
        target = str(test_samples)
        database = None
        output = "test_results.txt"
        phoenix_config = ".phoenix.config"
        upload_phoenix = False
        json = False
        quiet = False
        debug = False
    
    return scan_command(TestArgs())


def create_config_command(args):
    """Create Phoenix configuration template."""
    output = args.output or ".phoenix.config.TEMPLATE"
    PhoenixConfig.create_template(output)
    print()
    print("üìù Next steps:")
    print(f"   1. Copy {output} to .phoenix.config")
    print("   2. Fill in your Phoenix API credentials")
    print("   3. Run scan with --upload-phoenix flag")
    return 0


def main():
    """Main CLI entry point."""
    parser = argparse.ArgumentParser(
        description="Universal Vulnerability Scanner - Detect vulnerabilities across multiple ecosystems",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Scan a directory
  %(prog)s scan /path/to/project

  # Scan with JSON output
  %(prog)s scan /path/to/project --json --output results.json

  # Scan and upload to Phoenix
  %(prog)s scan /path/to/project --upload-phoenix

  # Run tests
  %(prog)s test

  # Create Phoenix config template
  %(prog)s create-config
        """
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Command to execute')
    
    # Scan command
    scan_parser = subparsers.add_parser('scan', help='Scan for vulnerabilities')
    scan_parser.add_argument('target', help='Directory or file to scan')
    scan_parser.add_argument('--database', '-d', help='Path to vulnerability database JSON')
    scan_parser.add_argument('--output', '-o', help='Output file for report')
    scan_parser.add_argument('--json', action='store_true', help='Output in JSON format')
    scan_parser.add_argument('--quiet', '-q', action='store_true', help='Suppress console output')
    scan_parser.add_argument('--upload-phoenix', action='store_true', help='Upload findings to Phoenix Security')
    scan_parser.add_argument('--phoenix-config', default='.phoenix.config', help='Phoenix configuration file')
    scan_parser.add_argument('--debug', action='store_true', help='Enable debug mode (save payloads)')
    
    # Test command
    test_parser = subparsers.add_parser('test', help='Run tests on sample data')
    
    # Create config command
    config_parser = subparsers.add_parser('create-config', help='Create Phoenix configuration template')
    config_parser.add_argument('--output', '-o', help='Output file path (default: .phoenix.config.TEMPLATE)')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return 0
    
    # Execute command
    if args.command == 'scan':
        return scan_command(args)
    elif args.command == 'test':
        return test_command(args)
    elif args.command == 'create-config':
        return create_config_command(args)
    else:
        parser.print_help()
        return 1


if __name__ == '__main__':
    sys.exit(main())


