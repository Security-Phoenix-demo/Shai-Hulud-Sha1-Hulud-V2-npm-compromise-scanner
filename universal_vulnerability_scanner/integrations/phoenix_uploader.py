#!/usr/bin/env python3
"""
Phoenix Security Platform Integration
Uploads vulnerability findings to Phoenix Security platform
Adapted from enhanced_npm_compromise_detector_phoenix.py
"""

import json
import os
from typing import List, Dict, Optional, Any
from datetime import datetime
from pathlib import Path
import requests
from requests.auth import HTTPBasicAuth

from ..models.finding import Finding


class PhoenixConfig:
    """Phoenix API configuration."""
    
    def __init__(self, config_file: str = ".phoenix.config"):
        """
        Load Phoenix configuration from file or environment.
        
        Priority:
        1. Environment variables
        2. Config file
        
        Args:
            config_file: Path to configuration file
        """
        self.client_id = None
        self.client_secret = None
        self.api_base_url = None
        self.assessment_name = "Universal Vulnerability Scanner"
        self.import_type = "new"
        
        # Try environment variables first
        if os.getenv('PHOENIX_CLIENT_ID'):
            self.client_id = os.getenv('PHOENIX_CLIENT_ID')
            self.client_secret = os.getenv('PHOENIX_CLIENT_SECRET')
            self.api_base_url = os.getenv('PHOENIX_API_URL')
            self.assessment_name = os.getenv('PHOENIX_ASSESSMENT_NAME', self.assessment_name)
            print("ğŸ” Loaded Phoenix config from environment variables")
            return
        
        # Try config file
        if os.path.exists(config_file):
            try:
                import configparser
                parser = configparser.ConfigParser()
                parser.read(config_file)
                
                if 'phoenix' in parser:
                    section = parser['phoenix']
                    self.client_id = section.get('client_id')
                    self.client_secret = section.get('client_secret')
                    self.api_base_url = section.get('api_base_url')
                    self.assessment_name = section.get('assessment_name', self.assessment_name)
                    self.import_type = section.get('import_type', self.import_type)
                    print(f"âœ… Loaded Phoenix config from {config_file}")
                else:
                    print(f"âš ï¸  No [phoenix] section in {config_file}")
            except Exception as e:
                print(f"âŒ Error loading Phoenix config: {e}")
    
    def is_configured(self) -> bool:
        """Check if Phoenix is properly configured."""
        return all([self.client_id, self.client_secret, self.api_base_url])
    
    @staticmethod
    def create_template(output_path: str = ".phoenix.config.TEMPLATE"):
        """Create a template configuration file."""
        template = """[phoenix]
# Phoenix Security API Configuration
client_id = your_client_id_here
client_secret = your_client_secret_here
api_base_url = https://api.securityphoenix.cloud
assessment_name = Universal Vulnerability Scanner - RSC Detection
import_type = new

# Environment variable alternatives:
# PHOENIX_CLIENT_ID=your_client_id
# PHOENIX_CLIENT_SECRET=your_client_secret
# PHOENIX_API_URL=https://api.securityphoenix.cloud
# PHOENIX_ASSESSMENT_NAME="Universal Vulnerability Scanner"
"""
        with open(output_path, 'w') as f:
            f.write(template)
        print(f"ğŸ“„ Created Phoenix config template: {output_path}")


class PhoenixUploader:
    """Upload vulnerability findings to Phoenix Security platform."""
    
    def __init__(self, config: PhoenixConfig, debug_mode: bool = False):
        """
        Initialize Phoenix uploader.
        
        Args:
            config: Phoenix configuration
            debug_mode: Enable debug logging and payload saving
        """
        self.config = config
        self.debug_mode = debug_mode
        self.access_token = None
        
        if debug_mode:
            os.makedirs("debug", exist_ok=True)
    
    def get_access_token(self) -> Optional[str]:
        """Get OAuth access token from Phoenix API."""
        if not self.config.is_configured():
            print("âŒ Phoenix not configured")
            return None
        
        url = f"{self.config.api_base_url}/v1/auth/access_token"
        
        try:
            response = requests.get(
                url,
                auth=HTTPBasicAuth(self.config.client_id, self.config.client_secret),
                timeout=30
            )
            
            if response.status_code == 200:
                token = response.json().get('token')
                print("âœ… Obtained Phoenix API access token")
                self.access_token = token
                return token
            else:
                print(f"âŒ Failed to get token: {response.status_code} - {response.text}")
                return None
        except Exception as e:
            print(f"âŒ Error getting Phoenix token: {e}")
            return None
    
    def create_asset(self, findings: List[Finding], repository: str = "unknown") -> Dict[str, Any]:
        """
        Create Phoenix asset with findings.
        
        Args:
            findings: List of findings for this asset
            repository: Repository URL or identifier
            
        Returns:
            Phoenix asset dictionary
        """
        # Group findings by file
        files_map = {}
        for finding in findings:
            if finding.path not in files_map:
                files_map[finding.path] = []
            files_map[finding.path].append(finding)
        
        # Use first file's path as build file
        build_file = list(files_map.keys())[0] if files_map else "unknown"
        
        asset = {
            "attributes": {
                "repository": repository,
                "buildFile": build_file,
                "origin": "github" if "github.com" in repository else "local"
            },
            "tags": [
                {"value": "vulnerability-scan"},
                {"value": "react-server-components"},
                {"value": "supply-chain"},
                {"value": "universal-scanner"}
            ],
            "installedSoftware": [],
            "findings": [f.to_phoenix_format() for f in findings]
        }
        
        return asset
    
    def upload_findings(self, findings: List[Finding], repository: str = "unknown") -> bool:
        """
        Upload findings to Phoenix Security.
        
        Args:
            findings: List of findings to upload
            repository: Repository identifier
            
        Returns:
            True if successful, False otherwise
        """
        if not self.config.is_configured():
            print("âŒ Phoenix not configured - skipping upload")
            return False
        
        if not findings:
            print("â„¹ï¸  No findings to upload")
            return True
        
        # Get access token
        if not self.access_token:
            token = self.get_access_token()
            if not token:
                return False
        
        # Create asset
        asset = self.create_asset(findings, repository)
        
        # Prepare payload
        payload = {
            "importType": self.config.import_type,
            "assessment": {
                "assetType": "BUILD",
                "name": self.config.assessment_name
            },
            "assets": [asset]
        }
        
        # Debug: save payload
        if self.debug_mode:
            self._save_debug_payload(payload)
        
        # Upload
        url = f"{self.config.api_base_url}/v1/import/assets"
        headers = {
            'Authorization': f'Bearer {self.access_token}',
            'Content-Type': 'application/json'
        }
        
        try:
            print(f"ğŸš€ Uploading {len(findings)} findings to Phoenix...")
            response = requests.post(
                url,
                headers=headers,
                json=payload,
                timeout=120
            )
            
            if self.debug_mode:
                self._save_debug_response(response, payload)
            
            if response.status_code in [200, 201]:
                print("âœ… Successfully uploaded to Phoenix Security")
                return True
            else:
                print(f"âŒ Upload failed: {response.status_code} - {response.text}")
                return False
        except Exception as e:
            print(f"âŒ Error uploading to Phoenix: {e}")
            return False
    
    def _save_debug_payload(self, payload: Dict[str, Any]):
        """Save request payload for debugging."""
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        path = f"debug/phoenix_payload_{timestamp}.json"
        
        with open(path, 'w', encoding='utf-8') as f:
            json.dump(payload, f, indent=2, ensure_ascii=False, default=str)
        
        print(f"ğŸ› Debug: Saved payload to {path}")
    
    def _save_debug_response(self, response: requests.Response, original_payload: Dict[str, Any]):
        """Save API response for debugging."""
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        path = f"debug/phoenix_response_{timestamp}.json"
        
        response_data = {
            "status_code": response.status_code,
            "status_text": response.reason,
            "headers": dict(response.headers),
            "url": response.url,
            "timestamp": timestamp,
            "success": response.status_code in [200, 201],
            "request_summary": {
                "assets_sent": len(original_payload.get('assets', [])),
                "findings_sent": sum(len(a.get('findings', [])) for a in original_payload.get('assets', []))
            }
        }
        
        try:
            if response.text:
                response_data["response_body"] = response.json()
        except:
            response_data["response_body"] = response.text
        
        with open(path, 'w', encoding='utf-8') as f:
            json.dump(response_data, f, indent=2, ensure_ascii=False, default=str)
        
        print(f"ğŸ› Debug: Saved response to {path}")


